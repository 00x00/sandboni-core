language: java
jdk:
  - openjdk8

install: true

stages:
  - name: release
    if: branch = master
  - name: pull request
    if: type = pull_request OR type = push AND branch != master

jobs:
  include:
    - stage: release
      name: "Release: mvn clean deploy"
      script:
        - mvn clean deploy --settings .maven.xml -DskipTests=true -B -U -Prelease

    - stage: pull request
      name: "Pull Request: mvn clean package sonar:sonar"
      script:
        - mvn --settings .maven.xml install sonar:sonar -DskipTests=true -Dgpg.skip -Dmaven.javadoc.skip=true -B -V


## export GPG details
before_install:
  - echo $GPG_SECRET_KEYS | base64 --decode | $GPG_EXECUTABLE --import
  - echo $GPG_OWNERTRUST | base64 --decode | $GPG_EXECUTABLE --import-ownertrust

## Get the project version
before_deploy:
  - mvn help:evaluate -N -Dexpression=project.version|grep -v '\['
  - export project_version=$(mvn help:evaluate -N -Dexpression=project.version|grep -v '\[')

## Create release in GitHub
deploy:
  provider: releases
  api_key:
    secure: "$SONAR_TOKEN"
  file:
    - sandboni-engine/target/sandboni-engine-$project_version.jar
    - sandboni-scm/target/sandboni-scm-$project_version.jar
  skip_cleanup: true
  on:
    repo: jpmorganchase/sandboni-core
  name: $project_version

addons:
  sonarcloud:
    organization: "sandboni"
    token:
      secure: "$SONAR_TOKEN"

cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.sonar/cache'